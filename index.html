<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padel Social Pro v7.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        button { touch-action: manipulation; }
        .score-input { 
            text-align: center; font-size: 1.75rem; font-weight: 800; width: 70px; height: 60px;
            border-radius: 0.5rem; border: 2px solid #e5e7eb; background: #fff; transition: all 0.2s;
        }
        .score-input:focus { border-color: #3b82f6; ring: 2px; outline: none; }
        .tab-btn { padding: 12px; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; flex: 1; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; background: #eff6ff; }
        .nav-pill { padding: 10px 20px; border-radius: 99px; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; text-align: center; }
        .nav-pill.active { background: white; color: #1e3a8a; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nav-pill.inactive { color: rgba(255,255,255,0.7); }
        .hidden { display: none !important; }
        .skipped-card { background-color: #f3f4f6; border-color: #d1d5db; opacity: 0.7; }
    </style>
</head>
<body class="text-gray-800 pb-24">

    <header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold flex items-center gap-2">üéæ Padel Social Pro <span class="text-xs opacity-50">v7.0</span></h1>
            <div class="flex gap-2">
                <button onclick="exportData()" class="text-xs bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded shadow">Save JSON</button>
                <button onclick="resetApp()" class="text-xs bg-red-500 hover:bg-red-600 px-3 py-1 rounded shadow">Reset App</button>
            </div>
        </div>
        <div class="flex bg-blue-800 p-1.5 rounded-full w-full max-w-md mx-auto">
            <div onclick="switchAppMode('social')" id="nav-social" class="nav-pill active w-1/2">Social Mixer</div>
            <div onclick="switchAppMode('tournament')" id="nav-tournament" class="nav-pill inactive w-1/2">Tournament</div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-3 md:p-6">
        
        <div id="app-social">
            <div id="setup-screen" class="bg-white p-5 rounded-xl shadow-lg space-y-6">
                <div class="border-b pb-2"><h2 class="text-2xl font-bold">Social Mixer</h2></div>
                <div>
                    <label class="block font-semibold mb-2 text-gray-700 text-sm uppercase">Play Style</label>
                    <div class="flex border rounded-lg overflow-hidden bg-gray-50">
                        <button class="tab-btn active" onclick="setSocialStyle('individual', this)">üë§ Individual</button>
                        <button class="tab-btn" onclick="setSocialStyle('fixed', this)">üë´ Pairs</button>
                        <button class="tab-btn" onclick="setSocialStyle('team', this)">‚öîÔ∏è Team Battle</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-blue-50 p-4 rounded-xl border">
                    <div class="col-span-1 md:col-span-1">
                        <label class="block font-semibold mb-1 text-sm text-blue-900">Rotation Logic</label>
                        <select id="pairingLogicSelect" class="w-full p-2 border rounded-lg bg-white h-10">
                            <option value="americano">Americano (Balanced)</option>
                            <option value="mexicano">Mexicano (Ladder)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm text-blue-900">Score Format</label>
                        <select id="scoreType" class="w-full p-2 border rounded-lg bg-white h-10" onchange="togglePointInput()">
                            <option value="fixed">Fixed Total</option>
                            <option value="open">Tennis / Open</option>
                        </select>
                    </div>
                    <div id="pointsInputContainer">
                        <label class="block font-semibold mb-1 text-sm text-blue-900">Target Points</label>
                        <select id="pointsPerMatch" class="w-full p-2 border rounded-lg h-10 bg-white font-bold">
                            <option value="16">16 Points</option>
                            <option value="21" selected>21 Points</option>
                            <option value="24">24 Points</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm text-blue-900">Courts</label>
                        <input type="number" id="courtCount" value="2" class="w-full p-2 border rounded-lg text-center font-bold h-10">
                    </div>
                </div>
                <div id="social-input-area"></div>
                <button onclick="startSocialGame()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-[0.98] transition">START MIXER üöÄ</button>
            </div>

            <div id="active-screen" class="hidden space-y-6">
                <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center sticky top-20 z-40 border border-gray-100">
                    <button onclick="changeRound(-1)" id="prevRoundBtn" class="p-2 rounded-lg text-gray-500 disabled:opacity-30 hover:bg-gray-100">¬´ Prev</button>
                    <div class="text-center">
                        <h2 class="text-xl font-black text-gray-800">ROUND <span id="socialRoundNumDisplay" class="text-blue-600">1</span></h2>
                    </div>
                    <button onclick="generateNextRound()" id="nextRoundBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">Next Round ¬ª</button>
                </div>
                <div id="matches-container" class="grid lg:grid-cols-2 gap-4"></div>
                <div class="bg-white rounded-xl shadow border overflow-hidden">
                    <div class="bg-gray-50 p-4 font-bold border-b text-gray-700">üèÜ Social Leaderboard</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-[10px] uppercase font-bold text-gray-400">
                                <tr><th class="p-3">#</th><th class="p-3">Name</th><th class="p-3 text-center">Played</th><th class="p-3 text-center">W-L-D</th><th class="p-3 text-right">Pts</th></tr>
                            </thead>
                            <tbody id="leaderboard-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="app-tournament" class="hidden">
            <div id="tourn-setup" class="bg-white p-6 rounded-xl shadow-lg space-y-8">
                <h2 class="text-2xl font-bold border-b pb-2 text-gray-800">Tournament Mode</h2>
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Play Format</label>
                        <select id="tournFormat" class="w-full p-3 border rounded-lg font-bold bg-gray-50" onchange="updateTournUI()">
                            <option value="fixed">üë´ Fixed Partners</option>
                            <option value="individual">üë§ Individual</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Groups (1-10)</label>
                        <select id="tournGroupCount" class="w-full p-3 border rounded-lg font-bold bg-gray-50" onchange="updateTournUI()">
                            <option value="1">1 Group</option><option value="2" selected>2 Groups</option><option value="3">3 Groups</option><option value="4">4 Groups</option>
                            <option value="5">5 Groups</option><option value="6">6 Groups</option><option value="7">7 Groups</option><option value="8">8 Groups</option><option value="9">9 Groups</option><option value="10">10 Groups</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Qualifiers / Group</label>
                        <select id="tournQualifiersCount" class="w-full p-3 border rounded-lg font-bold bg-gray-50">
                            <option value="1">Best 1 (Winner)</option><option value="2" selected>Best 2</option>
                        </select>
                    </div>
                </div>
                <div id="tourn-rosters" class="grid md:grid-cols-2 gap-6"></div>
                <button onclick="startTournament()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-[0.98]">CREATE TOURNAMENT üèÜ</button>
            </div>

            <div id="tourn-active" class="hidden space-y-8">
                <div id="phase-groups">
                    <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center mb-6 border">
                        <button onclick="changeTournRound(-1)" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 disabled:opacity-30">¬´ Prev</button>
                        <div class="text-center">
                            <h2 class="text-xl font-black text-gray-800">ROUND <span id="tournRoundDisplay" class="text-purple-600">1</span></h2>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">GROUP STAGE</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="generateTournRound()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg font-bold text-sm">New Round +</button>
                            <button onclick="generateBracket()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg font-bold text-sm">End Phase ¬ª</button>
                        </div>
                    </div>
                    <div id="groups-container" class="grid md:grid-cols-2 gap-8"></div>
                </div>
                <div id="phase-bracket" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-black text-gray-800">Phase 2: Knockout</h2>
                        <button id="final-advance-btn" onclick="advanceToFinal()" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg">Next Bracket Stage ¬ª</button>
                    </div>
                    <div id="bracket-view" class="flex flex-col gap-12 p-4 items-center"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let socialStyle = 'individual';
        let socialPlayers = [], roundsHistory = [], currentRoundIndex = 0;
        let tournData = { round: 0, groups: [], bracket: [], finalMatch: null, format: 'fixed', qualifiersPerGroup: 2 };
        let pointsCap = 21, totalCourts = 2, scoreType = 'fixed', currentPairingMode = 'americano';
        let tournRoundIndex = 0;

        // --- PERSISTENCE ENGINE ---
        function saveState() {
            const state = { socialStyle, socialPlayers, roundsHistory, currentRoundIndex, tournData, scoreType, pointsCap, currentPairingMode, tournRoundIndex,
                activeMode: document.getElementById('app-social').classList.contains('hidden') ? 'tournament' : 'social' };
            localStorage.setItem('padelPro_v7.0', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('padelPro_v7.0');
            if (!saved) { setSocialStyle('individual', document.querySelector('.tab-btn.active')); return; }
            const state = JSON.parse(saved);
            socialStyle = state.socialStyle; socialPlayers = state.socialPlayers; 
            roundsHistory = state.roundsHistory; currentRoundIndex = state.currentRoundIndex; 
            tournData = state.tournData || { round: 0, groups: [], bracket: [], finalMatch: null }; 
            scoreType = state.scoreType; pointsCap = state.pointsCap;
            currentPairingMode = state.currentPairingMode || 'americano';
            tournRoundIndex = state.tournRoundIndex || 0;
            
            switchAppMode(state.activeMode);
            if (state.activeMode === 'social' && socialPlayers.length > 0) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('active-screen').classList.remove('hidden');
                renderCurrentRound();
            } else if (state.activeMode === 'tournament' && tournData.groups.length > 0) {
                document.getElementById('tourn-setup').classList.add('hidden');
                document.getElementById('tourn-active').classList.remove('hidden');
                if(tournData.groups[0].history.length > 0) tournRoundIndex = Math.min(tournRoundIndex, tournData.groups[0].history.length - 1);
                renderTournGroups();
                if(tournData.bracket.length > 0) {
                    document.getElementById('phase-groups').classList.add('hidden');
                    document.getElementById('phase-bracket').classList.remove('hidden');
                    renderBracket();
                    if(!tournData.finalMatch) document.getElementById('final-advance-btn').classList.remove('hidden');
                }
            }
        }

        window.onload = loadState;

        function switchAppMode(mode) {
            document.getElementById('app-social').classList.add('hidden');
            document.getElementById('app-tournament').classList.add('hidden');
            document.getElementById(`app-${mode}`).classList.remove('hidden');
            document.querySelectorAll('.nav-pill').forEach(p => p.classList.replace('active', 'inactive'));
            document.getElementById(`nav-${mode}`).classList.replace('inactive', 'active');
            if(mode === 'tournament' && (!tournData.groups || tournData.groups.length === 0)) updateTournUI();
            saveState();
        }

        // --- SOCIAL MIXER LOGIC ---
        function setSocialStyle(style, btn) {
            socialStyle = style;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const container = document.getElementById('social-input-area');
            if (style === 'team') {
                container.innerHTML = `<div class="grid grid-cols-2 gap-4 mt-2">
                    <div><label class="block text-xs font-bold text-blue-600 mb-1 uppercase">Team Blue</label><textarea id="inputTeamA" rows="6" class="w-full border rounded p-3 text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-red-600 mb-1 uppercase">Team Red</label><textarea id="inputTeamB" rows="6" class="w-full border rounded p-3 text-sm"></textarea></div>
                </div>`;
            } else {
                const ph = style === 'fixed' ? 'Pair A\nPair B' : 'Player 1\nPlayer 2';
                container.innerHTML = `<label class="block text-sm font-bold text-gray-600 mb-1 mt-2">Enter Names</label><textarea id="inputGeneral" rows="6" class="w-full p-4 border rounded-xl" placeholder="${ph}"></textarea>`;
            }
        }

        function togglePointInput() { 
            scoreType = document.getElementById('scoreType').value; 
            document.getElementById('pointsInputContainer').style.visibility = (scoreType === 'open') ? 'hidden' : 'visible'; 
        }

        function startSocialGame() {
            scoreType = document.getElementById('scoreType').value;
            currentPairingMode = document.getElementById('pairingLogicSelect').value;
            totalCourts = parseInt(document.getElementById('courtCount').value);
            pointsCap = parseInt(document.getElementById('pointsPerMatch').value);
            socialPlayers = [];
            if(socialStyle === 'team') {
                document.getElementById('inputTeamA').value.split('\n').forEach((n, i) => { if(n.trim()) socialPlayers.push({ id: 'B'+i, name: n.trim(), team: 'Blue' }); });
                document.getElementById('inputTeamB').value.split('\n').forEach((n, i) => { if(n.trim()) socialPlayers.push({ id: 'R'+i, name: n.trim(), team: 'Red' }); });
            } else {
                document.getElementById('inputGeneral').value.split('\n').forEach((n, i) => { if(n.trim()) socialPlayers.push({ id: i, name: n.trim() }); });
            }
            if(socialPlayers.length < 4) return alert("Add at least 4 players.");
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('active-screen').classList.remove('hidden');
            generateNextRound();
        }

        function generateNextRound() {
            if (roundsHistory.length > 0) {
                const unsubmitted = roundsHistory[currentRoundIndex].matches.filter(m => !m.submitted);
                if (unsubmitted.length > 0) return alert("Finish all matches first.");
            }

            // --- BALANCED PAIRING LOGIC ---
            // 1. Calculate current play count for everyone
            const stats = calculateSocialStats(); 
            // 2. Sort pool: Least played go first
            let pool = [...socialPlayers];
            if(currentPairingMode === 'americano') {
                pool.sort((a,b) => (stats[a.id].played - stats[b.id].played) || (0.5 - Math.random()));
            } else { // Mexicano (Ladder)
                pool.sort((a,b) => stats[b.id].pts - stats[a.id].pts);
            }
            
            let matches = [];
            if(socialStyle === 'team') {
                let b = pool.filter(p => p.team === 'Blue'), r = pool.filter(p => p.team === 'Red');
                while(b.length >= 2 && r.length >= 2 && matches.length < totalCourts) matches.push({ team1: [b.shift(), b.shift()], team2: [r.shift(), r.shift()], score1: 0, score2: 0, submitted: false, skipped: false });
            } else if(socialStyle === 'fixed') {
                while(pool.length >= 2 && matches.length < totalCourts) matches.push({ team1: [pool.shift()], team2: [pool.shift()], score1: 0, score2: 0, submitted: false, skipped: false });
            } else {
                while(pool.length >= 4 && matches.length < totalCourts) matches.push({ team1: [pool.shift(), pool.shift()], team2: [pool.shift(), pool.shift()], score1: 0, score2: 0, submitted: false, skipped: false });
            }
            roundsHistory.push({ roundNum: roundsHistory.length + 1, matches });
            currentRoundIndex = roundsHistory.length - 1;
            renderCurrentRound(); saveState();
        }

        function renderCurrentRound() {
            const data = roundsHistory[currentRoundIndex];
            document.getElementById('socialRoundNumDisplay').innerText = data.roundNum;
            const container = document.getElementById('matches-container'); container.innerHTML = '';
            
            data.matches.forEach((m, i) => {
                const isSkipped = m.skipped;
                const cardClass = isSkipped ? 'skipped-card rounded-xl border p-4' : `bg-white p-4 rounded-xl border ${m.submitted ? 'bg-green-50 border-green-400' : 'shadow-sm'}`;
                const inputState = isSkipped ? 'disabled' : '';
                
                let skipBtn = '';
                // Enable Skip button only if not submitted yet
                if(!m.submitted) {
                    skipBtn = `<button onclick="skipSocialMatch(${i})" class="w-1/3 py-2 bg-gray-200 text-gray-500 rounded font-bold ml-2 hover:bg-gray-300">Skip</button>`;
                } else if (m.skipped) {
                    skipBtn = `<button onclick="skipSocialMatch(${i})" class="w-1/3 py-2 bg-gray-200 text-gray-500 rounded font-bold ml-2 hover:bg-gray-300">Restore</button>`;
                }

                container.innerHTML += `<div class="${cardClass} relative">
                    ${isSkipped ? '<div class="absolute inset-0 flex items-center justify-center font-black text-gray-400 text-xl tracking-widest uppercase pointer-events-none">Skipped</div>' : ''}
                    <div class="flex justify-between items-center mb-2"><span class="truncate w-32 font-bold text-blue-800">${m.team1.map(p=>p.name).join(' & ')}</span><input type="number" ${inputState} class="w-16 border text-center font-bold text-xl rounded" value="${m.score1}" onchange="updateSocialScore(${i}, 1, this.value)"></div>
                    <div class="flex justify-between items-center mb-4"><span class="truncate w-32 font-bold text-red-800">${m.team2.map(p=>p.name).join(' & ')}</span><input type="number" ${inputState} class="w-16 border text-center font-bold text-xl rounded" value="${m.score2}" onchange="updateSocialScore(${i}, 2, this.value)"></div>
                    <div class="flex">
                        <button onclick="submitSocialMatch(${i})" class="flex-1 py-2 bg-gray-800 text-white rounded font-bold hover:bg-gray-700" ${isSkipped ? 'disabled' : ''}>${m.submitted ? 'Locked' : 'Submit Score'}</button>
                        ${skipBtn}
                    </div>
                </div>`;
            });
            recalcSocialLeaderboard();
        }

        function updateSocialScore(idx, team, val) {
            const m = roundsHistory[currentRoundIndex].matches[idx];
            const s = parseInt(val) || 0;
            if (scoreType === 'fixed') {
                if (team === 1) { m.score1 = Math.min(s, pointsCap); m.score2 = pointsCap - m.score1; }
                else { m.score2 = Math.min(s, pointsCap); m.score1 = pointsCap - m.score2; }
            } else {
                if (team === 1) m.score1 = s; else m.score2 = s;
            }
            renderCurrentRound(); saveState();
        }

        function submitSocialMatch(idx) {
            const m = roundsHistory[currentRoundIndex].matches[idx];
            if(m.skipped) return;
            m.submitted = !m.submitted;
            renderCurrentRound(); saveState();
        }

        function skipSocialMatch(idx) {
            const m = roundsHistory[currentRoundIndex].matches[idx];
            if (m.skipped) {
                m.skipped = false; m.submitted = false; // Restore
            } else {
                m.skipped = true; m.submitted = true; m.score1 = 0; m.score2 = 0; // Skip
            }
            renderCurrentRound(); saveState();
        }

        function calculateSocialStats() {
            const stats = {};
            socialPlayers.forEach(p => stats[p.id] = { name: p.name, pts: 0, played: 0, w:0, l:0, d:0 });
            roundsHistory.forEach(r => r.matches.forEach(m => {
                // Ignore skipped matches for stats
                if (m.submitted && !m.skipped) {
                    const t1 = m.team1, t2 = m.team2;
                    t1.forEach(p => { stats[p.id].pts+=m.score1; stats[p.id].played++; });
                    t2.forEach(p => { stats[p.id].pts+=m.score2; stats[p.id].played++; });
                    if(m.score1 > m.score2) { t1.forEach(p=>stats[p.id].w++); t2.forEach(p=>stats[p.id].l++); }
                    else if(m.score2 > m.score1) { t2.forEach(p=>stats[p.id].w++); t1.forEach(p=>stats[p.id].l++); }
                    else { t1.forEach(p=>stats[p.id].d++); t2.forEach(p=>stats[p.id].d++); }
                }
            }));
            return stats;
        }

        function recalcSocialLeaderboard() {
            const stats = calculateSocialStats();
            const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '';
            Object.values(stats).sort((a,b) => b.pts - a.pts || b.w - a.w).forEach((s, i) => {
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-gray-400">#${i+1}</td><td class="p-3 font-bold">${s.name}</td><td class="p-3 text-center">${s.played}</td><td class="p-3 text-center text-xs font-mono">${s.w}-${s.l}-${s.d}</td><td class="p-3 text-right font-black text-blue-600">${s.pts}</td></tr>`;
            });
        }

        // --- TOURNAMENT ENGINE (Same as v6.9) ---
        function updateTournUI() {
            const count = parseInt(document.getElementById('tournGroupCount').value);
            const container = document.getElementById('tourn-rosters'); container.innerHTML = '';
            for(let i=0; i<count; i++) container.innerHTML += `<div class="bg-white p-3 rounded-lg border shadow-sm"><label class="block text-xs font-black text-purple-600 uppercase mb-1">Group ${String.fromCharCode(65+i)}</label><textarea id="roster-${i}" rows="4" class="w-full border rounded p-2 text-sm" placeholder="Names..."></textarea></div>`;
        }

        function startTournament() {
            tournData.format = document.getElementById('tournFormat').value;
            tournData.qualifiersPerGroup = parseInt(document.getElementById('tournQualifiersCount').value);
            tournData.groups = []; tournData.round = 0; tournData.finalMatch = null;
            const groupCount = parseInt(document.getElementById('tournGroupCount').value);
            
            for(let i=0; i<groupCount; i++) {
                const roster = [];
                const input = document.getElementById(`roster-${i}`);
                if(input) {
                    input.value.split('\n').forEach((n, idx) => { if(n.trim()) roster.push({ id: `T${i}-${idx}`, name: n.trim(), pool: String.fromCharCode(65+i) }); });
                }
                tournData.groups.push({ name: String.fromCharCode(65+i), players: roster, history: [] });
            }
            if(tournData.groups.some(g => g.players.length < 2)) return alert("All groups must have at least 2 teams.");
            document.getElementById('tourn-setup').classList.add('hidden');
            document.getElementById('tourn-active').classList.remove('hidden');
            generateTournRound(); saveState();
        }

        function generateTournRound() {
            tournData.round++; 
            setTimeout(() => { const rd = document.getElementById('tournRoundDisplay'); if(rd) rd.innerText = tournData.round; }, 50);
            tournData.groups.forEach(g => {
                let pool = [...g.players].sort(() => 0.5 - Math.random());
                let matches = [];
                while(pool.length >= (tournData.format==='fixed'?2:4)) {
                    if(tournData.format==='fixed') matches.push({ team1:[pool.shift()], team2:[pool.shift()], score1:0, score2:0, submitted:false });
                    else matches.push({ team1:[pool.shift(), pool.shift()], team2:[pool.shift(), pool.shift()], score1:0, score2:0, submitted:false });
                }
                g.history.push(matches);
            });
            tournRoundIndex = tournData.round - 1;
            renderTournGroups(); saveState();
        }

        function changeTournRound(delta) {
            const maxRound = tournData.groups[0].history.length - 1;
            tournRoundIndex = Math.max(0, Math.min(maxRound, tournRoundIndex + delta));
            renderTournGroups(); saveState();
        }

        function renderTournGroups() {
            const container = document.getElementById('groups-container'); 
            if(!container) return; container.innerHTML = '';
            document.getElementById('tournRoundDisplay').innerText = tournRoundIndex + 1;
            
            tournData.groups.forEach(g => {
                if(!g.players || g.players.length === 0) return;
                const stats = calculateTournStats(g.players, g.history.map(m => ({ matches: m })));
                const currentMatches = g.history[tournRoundIndex] || [];
                let tableHtml = `<thead class="bg-gray-50 text-[10px] text-gray-500 font-bold uppercase"><tr><th class="p-2">#</th><th class="p-2 w-1/3">Team</th><th class="p-2 text-center">Pl</th><th class="p-2 text-center">W-L-D</th><th class="p-2 text-center">+/-</th><th class="p-2 text-right">Pts</th></tr></thead><tbody>`;
                tableHtml += Object.values(stats).sort((a,b) => b.ptsWon - a.ptsWon || b.diff - a.diff).map((s,i) => `<tr class="border-b ${i<tournData.qualifiersPerGroup?'bg-yellow-50 font-bold':''}"><td class="p-2 text-xs">${i+1}</td><td class="p-2 text-xs truncate max-w-[100px]">${s.name}</td><td class="p-2 text-xs text-center">${s.played}</td><td class="p-2 text-xs text-center font-mono">${s.w}-${s.l}-${s.d}</td><td class="p-2 text-xs text-center">${s.diff > 0 ? '+' : ''}${s.diff}</td><td class="p-2 text-right text-xs font-black text-blue-600">${s.ptsWon}</td></tr>`).join('') + `</tbody>`;
                let matchHtml = currentMatches.map((m, i) => {
                    const btnText = m.submitted ? 'Locked (Tap to Edit)' : 'Submit';
                    return `<div class="bg-white p-2 rounded border mb-2 ${m.submitted?'bg-gray-50 border-gray-300':''}">
                    <div class="flex justify-between mb-1"><span class="text-xs truncate font-bold text-blue-800 w-2/3">${m.team1.map(p=>p.name).join('&')}</span><input type="number" ${m.submitted?'disabled':''} class="w-8 border text-center rounded h-6" value="${m.score1}" onchange="updateTournScoreValue('${g.name}', ${tournRoundIndex}, ${i}, 1, this.value)"></div>
                    <div class="flex justify-between mb-2"><span class="text-xs truncate font-bold text-red-800 w-2/3">${m.team2.map(p=>p.name).join('&')}</span><input type="number" ${m.submitted?'disabled':''} class="w-8 border text-center rounded h-6" value="${m.score2}" onchange="updateTournScoreValue('${g.name}', ${tournRoundIndex}, ${i}, 2, this.value)"></div>
                    <button onclick="toggleTournSubmit('${g.name}', ${tournRoundIndex}, ${i})" class="w-full py-1 text-[9px] text-white rounded font-bold transition ${m.submitted?'bg-gray-600 hover:bg-gray-700':'bg-green-600 hover:bg-green-700'}">${btnText}</button>
                </div>`}).join('');
                container.innerHTML += `<div class="bg-white border rounded-xl overflow-hidden shadow-md"><div class="bg-purple-600 p-2 font-black text-white text-sm">GROUP ${g.name}</div><div class="p-3"><table class="w-full mb-4">${tableHtml}</table><div class="mt-4 border-t pt-2">${matchHtml}</div></div></div>`;
            });
        }

        function calculateTournStats(players, history) {
            const stats = {}; players.forEach(p => stats[p.id] = { name: p.name, ptsWon: 0, diff: 0, w:0, l:0, d:0, played:0 });
            history.forEach(r => r.matches.forEach(m => {
                if(m.submitted) {
                    m.team1.forEach(p=>{ stats[p.id].played++; stats[p.id].ptsWon+=m.score1; stats[p.id].diff+=(m.score1-m.score2); if(m.score1>m.score2) stats[p.id].w++; else if(m.score2>m.score1) stats[p.id].l++; else stats[p.id].d++; });
                    m.team2.forEach(p=>{ stats[p.id].played++; stats[p.id].ptsWon+=m.score2; stats[p.id].diff+=(m.score2-m.score1); if(m.score2>m.score1) stats[p.id].w++; else if(m.score1>m.score2) stats[p.id].l++; else stats[p.id].d++; });
                }
            }));
            return stats;
        }

        function toggleTournSubmit(groupName, rIdx, mIdx) {
            const g = tournData.groups.find(x => x.name === groupName);
            g.history[rIdx][mIdx].submitted = !g.history[rIdx][mIdx].submitted;
            renderTournGroups(); saveState();
        }

        function updateTournScoreValue(groupName, rIdx, mIdx, teamNum, val) {
            const g = tournData.groups.find(x => x.name === groupName);
            const match = g.history[rIdx][mIdx];
            if(teamNum === 1) match.score1 = parseInt(val) || 0; else match.score2 = parseInt(val) || 0;
            saveState();
        }

        // --- KNOCKOUT ENGINE ---
        function generateBracket() {
            const winnersPool = []; const runnersPool = [];
            tournData.groups.forEach(g => {
                const stats = calculateTournStats(g.players, g.history.map(m => ({ matches: m })));
                const sorted = Object.values(stats).sort((a,b) => b.ptsWon - a.ptsWon || b.diff - a.diff);
                if (sorted[0]) winnersPool.push({ name: sorted[0].name, pool: g.name, rank: 1 });
                if (sorted[1]) runnersPool.push({ name: sorted[1].name, pool: g.name, rank: 2 });
                if (tournData.qualifiersPerGroup === 1 && sorted[0]) runnersPool.push({ name: sorted[0].name, pool: g.name, rank: 1});
            });

            let teams = [];
            if (tournData.qualifiersPerGroup === 2) {
                winnersPool.sort(() => 0.5 - Math.random()); runnersPool.sort(() => 0.5 - Math.random());
                while (winnersPool.length > 0 && runnersPool.length > 0) {
                    let w = winnersPool.shift();
                    let rIndex = runnersPool.findIndex(p => p.pool !== w.pool);
                    if (rIndex === -1) rIndex = 0; 
                    let r = runnersPool.splice(rIndex, 1)[0];
                    if (tournData.format === 'individual') teams.push({ name: `${w.name} & ${r.name}` }); 
                    else { teams.push({ name: w.name }); teams.push({ name: r.name }); }
                }
            } 
            if (teams.length === 0) {
                 const all = [...winnersPool, ...runnersPool].sort(() => 0.5 - Math.random());
                 while(all.length >= 2) {
                     let p1 = all.shift();
                     if (tournData.format === 'individual') teams.push({ name: `${p1.name} & ${all.shift().name}` });
                     else { teams.push({ name: p1.name }); teams.push({ name: all.shift().name }); }
                 }
            }

            const matches = [];
            for(let i=0; i<teams.length; i+=2) if(teams[i+1]) matches.push({ id: Math.random(), t1: teams[i], t2: teams[i+1], s1: 0, s2: 0 });
            tournData.bracket = matches; tournData.finalMatch = null;
            document.getElementById('phase-groups').classList.add('hidden');
            document.getElementById('phase-bracket').classList.remove('hidden');
            document.getElementById('final-advance-btn').classList.remove('hidden');
            renderBracket(); saveState();
        }

        function renderBracket() {
            const container = document.getElementById('bracket-view'); let html = '';
            tournData.bracket.forEach((m, idx) => {
                let win = m.s1 > m.s2 ? 1 : m.s2 > m.s1 ? 2 : 0;
                html += `<div class="w-[400px] bg-white rounded-xl shadow-lg border overflow-hidden mb-8">
                    <div class="p-4 flex justify-between items-center ${win===1?'bg-green-100 border-green-500':''}">
                        <span class="font-black text-blue-900">${m.t1.name}</span><input type="number" class="score-input w-16 h-10 text-lg" value="${m.s1}" onchange="tournData.bracket[${idx}].s1=parseInt(this.value);renderBracket();saveState();">
                    </div>
                    <div class="p-4 flex justify-between items-center border-t ${win===2?'bg-green-100 border-green-500':''}">
                        <span class="font-black text-red-900">${m.t2.name}</span><input type="number" class="score-input w-16 h-10 text-lg" value="${m.s2}" onchange="tournData.bracket[${idx}].s2=parseInt(this.value);renderBracket();saveState();">
                    </div>
                </div>`;
            });
            if(tournData.finalMatch) {
                let m = tournData.finalMatch, win = m.s1 > m.s2 ? 1 : m.s2 > m.s1 ? 2 : 0;
                html += `<div class="mt-8 text-center uppercase font-black text-gray-400">Grand Final</div><div class="w-[400px] bg-white rounded-xl shadow-2xl border-4 border-yellow-400 overflow-hidden">
                    <div class="p-4 flex justify-between items-center ${win===1?'bg-yellow-100':''}"><span class="font-black text-blue-900">${m.t1.name}</span><input type="number" class="score-input w-16 h-10" value="${m.s1}" onchange="tournData.finalMatch.s1=parseInt(this.value);renderBracket();saveState();"></div>
                    <div class="p-4 flex justify-between items-center border-t ${win===2?'bg-yellow-100':''}"><span class="font-black text-red-900">${m.t2.name}</span><input type="number" class="score-input w-16 h-10" value="${m.s2}" onchange="tournData.finalMatch.s2=parseInt(this.value);renderBracket();saveState();"></div></div>`;
            }
            container.innerHTML = html;
        }

        function advanceToFinal() {
            const winners = tournData.bracket.map(m => m.s1 > m.s2 ? m.t1 : (m.s2 > m.s1 ? m.t2 : null));
            if(winners.includes(null)) return alert("Fill all scores first!");
            if (tournData.finalMatch && (tournData.finalMatch.s1 > 0 || tournData.finalMatch.s2 > 0)) return alert("Tournament Finished!");
            if (winners.length === 2) {
                tournData.bracket = []; 
                tournData.finalMatch = { t1: winners[0], t2: winners[1], s1: 0, s2: 0 };
                document.getElementById('final-advance-btn').innerText = "Finish Tournament";
            } else if (winners.length >= 2) {
                const nextRound = [];
                for(let i=0; i<winners.length; i+=2) {
                    if(winners[i+1]) nextRound.push({ id: Math.random(), t1: winners[i], t2: winners[i+1], s1:0, s2:0 });
                }
                tournData.bracket = nextRound;
            }
            renderBracket(); saveState();
        }

        function resetApp() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }
        function changeRound(delta) { currentRoundIndex = Math.max(0, Math.min(roundsHistory.length - 1, currentRoundIndex + delta)); renderCurrentRound(); }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('padelPro_v7.0'));
            const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", "padel_backup.json");
            document.body.appendChild(node); node.click(); node.remove();
        }
    </script>
</body>
</html>